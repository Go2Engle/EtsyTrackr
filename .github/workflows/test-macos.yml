name: Test macOS Build

on:
  push:
    branches:
      - mac-builds
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'

jobs:
  test-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11.8

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade pyinstaller
          pip install -r requirements.txt
          brew install create-dmg

      - name: Free up disk space
        run: |
          sudo rm -rf /Library/Developer/CommandLineTools
          sudo rm -rf /usr/local/lib/node_modules
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/share/swift
          brew cleanup

      - name: Show environment info
        run: |
          python --version
          pip list
          pyinstaller --version
          ls -la
          pwd

      - name: Build DMG
        run: |
          # Build with verbose output
          python build.py --mode dmg
          
          # Show build artifacts
          echo "Contents of dist directory:"
          ls -R dist/
          
          if [ -d "dist/dir/EtsyTrackr.app" ]; then
            echo "App bundle structure:"
            ls -R dist/dir/EtsyTrackr.app/
          fi

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            build/*.log
            build/*.txt
            dist/**/*
            *.log
            *.txt
            Info.plist
